# ARIA Engineering Patterns

ARIA の物理的な掟（Code-rooted Facts）に基づいた実装パターンです。

## 1. RaW-V (Reliability and Watch-ability Verification)
マスタデータの更新など、破壊的な操作を伴う処理では以下の手順を「義務」とする。
- **Snapshot**: 処理開始前に `CatalogManager.take_snapshot()` を実行。
- **Rollback**: 予期せぬエラーや整合性不備を検知した場合、即座に `CatalogManager.rollback()` を実行し、データ状態を復旧させる。

## 2. データ整合性の禁忌
- **Nullable Boolean の死守**: `is_active` 等のブール値カラムに対し、`astype(str)` や `fillna("")` を適用してはならない。これらは分析時の曖昧さを生む原因となる。
- **不変シャッディング**: 証券コードの上 2 桁による物理分割（`bin=XX`）を維持し、ファイル名やパス構造を独断で変更してはならない。

## 3. 上場イベントの命名規則
- `LISTING`: 初回検知時。
- `DELISTING`: 前回の `is_active=True` 銘柄が消失した時。
- `RE_LISTING`: 一度 `DELISTING` になった銘柄が再出現した時。

## 4. 異常値の防止 (Anomaly Prevention)
- **指数閾値ガード**: 構成銘柄の取得結果が 40 件を下回る場合、API エラーまたは「空の結果」とみなし、マスタへの反映を停止する。
- **遡りガード (Preservation Priority)**: 古いデータほど API から消えるリスクが高いため、バックフィルは「古い方から順に（過去から未来へ）」進める。

## 5. 型設計 / 整合性
- **Pydantic Strict Mode**: 外部データのバリデーションには常に `BaseModel` を使用し、意図しない型変換を遮断する。
- **時制の整合性**: 金融データにおける「時間の逆流」を許容しない。
- **Boolean 整合性**: 論理値に `astype(str)` を絶対に使用しない（Nullable Boolean の死守）。

## 4. 環境・ネットワークの堅牢化 (Stability)
- **CI 環境の最適化**: ログの肥大化を防ぐため、`HF_HUB_DISABLE_PROGRESS_BARS=1` および `TQDM_DISABLE=1` を強制する。
- **物理的リトライ注入**: `network_utils.patch_all_networking` により、すべての外部ライブラリ（HF Hub, EDINET）に堅牢なリトライ Session（バックオフ係数 2.0, Read Timeout 180s）を強制注入する。
