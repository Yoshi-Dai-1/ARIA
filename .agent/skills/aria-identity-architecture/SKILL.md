---
name: aria-identity-architecture
description: ARIA の識別子ヒエラルキー（JCN/EDINET Code/証券コード）の設計思想と、コード変更シナリオへの対応戦略。
---
# ARIA 識別子アーキテクチャ (Identity Architecture)

ARIA が「企業の同一性」をどのように追跡・保証するかを定義するスキル。

## 1. 3層識別子ヒエラルキー

| 層 | 識別子 | 安定性 | 管轄 | ARIA での役割 |
|:--:|:-------|:------:|:----:|:-------------|
| 🔒 | **JCN (法人番号)** | 完全不変 | 国税庁 | 物理パスの分散キー (`bin=JXX`) |
| ⚠️ | **EDINET Code** | 準静的 | 金融庁 | マスタの主キー (`stocks_master`) |
| 🔄 | **証券コード (5桁)** | 動的 | JPX | 市場データとの接続インターフェース |

**設計原則**: 下位の識別子が変更されても、上位の識別子で企業の一貫性を保証する。

## 2. コード変更シナリオと ARIA の対応

| シナリオ | JCN | EDINET Code | 証券コード | ARIA の対応 |
|:---------|:---:|:-----------:|:----------:|:-----------|
| 商号変更 | 不変 | 不変 | 不変 | `name_history` に記録 |
| EDINET集約 | 不変 | **変更** | 不変 | `aggregation_map` で自動マッピング |
| 合併吸収 | **閉鎖** | **変更** | **変更** | `former_edinet_codes` に旧コード保持 |
| 新設合併 | **新規** | **新規** | **新規** | 旧法人のRAWは旧JCN bin に不変のまま保存 |

> **物理ファイル（RAW）は一切移動しない**。名寄せはインデックス層（`stocks_master`）で論理的に行う。

## 3. 集約ブリッジの検知メカニズム

起動時に金融庁の `ESE140190.csv`（集約一覧）をダウンロードし、`aggregation_map` を構築。
`_update_master_from_edinet_codes()` 内で旧コード→新コードの自動リンクを生成。

## 詳細リファレンス
- [キー構造の物理的根拠と法的根拠](references/KEY_STRUCTURE.md)
