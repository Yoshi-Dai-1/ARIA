# ARIA キー構造の物理的根拠と法的根拠

## 1. JCN（法人番号）の不変性

### 法的根拠
- **番号法 第8条**: 1法人＝1番号。支店・部署ごとに番号が発行されることはない。
- **再利用の禁止**: 法人が解散・消滅してもその JCN は永久欠番。国税庁「法人番号管理室」がシステムレベルで制御。

### JCN が変わる唯一のケース
- **合併による法人の消滅**: 被合併法人の JCN は**閉鎖**され、存続法人の JCN が継続される。
- **新設合併**: 全法人の JCN が閉鎖され、新法人に新しい JCN が付与される。
- いずれの場合も「変更」ではなく「閉鎖＋新規発行」である点が重要。

## 2. EDINET Code の変更可能性

### 物理的根拠 (EDINET 仕様書 3-1-8-2)
EDINET コードはシステム管理上の理由で変更されうる：
- **集約処理**: 同一提出者が複数コードを持っていた場合の整理（集約一覧 `ESE140190.csv` で公表）
- **EDINET システム刷新**: 過去にシステム更新でコードが一斉変更された実績あり

### ARIA の対応
1. **起動時の自動検知**: `sync_edinet_code_lists()` で集約一覧をダウンロード
2. **ブリッジ構築**: `aggregation_map` (旧→新) をメモリにロード
3. **マスタ反映**: `former_edinet_codes` フィールドに旧コードを保持
4. **データ遡及**: 旧コードで検索すると新コードのレコードにリダイレクト

## 3. 証券コードの動的変更

### 変更事例
- 持株会社移行（例: 4689 → 新コード、2023年 LINEヤフー統合）
- 市場区分再編（2022年4月 東証市場再編）
- 合併・分割に伴うリコード

### ARIA の対応
- カタログには「提出時点の証券コード」をそのまま記録（時系列スナップショット）
- `stocks_master` には最新の証券コードを保持
- 過去データの参照時は `edinet_code` をキーにして一貫性を保証

## 4. edinet_code と JCN が同時に変更されるケース

**回答: 合併時のみ**

合併の場合のデータフロー：
```
旧法人A (JCN-A, EDINET-A) → 消滅 (JCN-A は永久閉鎖)
旧法人B (JCN-B, EDINET-B) → 存続 (JCN-B, EDINET-B は不変)

ARIA の処理:
1. ESE140190.csv で EDINET-A → EDINET-B のマッピングを検知
2. stocks_master の EDINET-B レコードに former_edinet_codes = "EDINET-A" を追記
3. 旧法人A の RAW データは bin=J{JCN-A末尾2桁} に不変のまま残存
4. 検索時は EDINET-B → former_edinet_codes → 旧データを動的に統合
```
