name: Daily EDINET Extract

on:
  schedule:
    - cron: '0 15 * * *'  # 毎日日本時間 0:00 (UTC 15:00)
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start Date (YYYY-MM-DD)'
        required: true
        default: '2024-06-01'
      end_date:
        description: 'End Date (YYYY-MM-DD)'
        required: true
        default: '2024-06-30'

jobs:
  discovery:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - id: set-matrix
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
          EXTRACT_START: ${{ github.event.inputs.start_date || '2024-06-01' }}
          EXTRACT_END: ${{ github.event.inputs.end_date || '2024-06-30' }}
        run: |
          # 全書類IDをリスト取得
          IDS=$(python main.py --list-only --start "$EXTRACT_START" --end "$EXTRACT_END")
          # 4等分するJSONを生成
          MATRIX=$(python -c "
          import json, math
          ids = json.loads('$IDS')
          n = 4
          size = math.ceil(len(ids) / n)
          chunks = [ids[i:i + size] for i in range(0, len(ids), size)]
          print(json.dumps([{'ids': ','.join(c), 'idx': i} for i, c in enumerate(chunks) if c]))
          ")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  extract:
    needs: discovery
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        chunk: ${{ fromJson(needs.discovery.outputs.matrix) }}
    timeout-minutes: 360
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Extraction
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
          EXTRACT_START: ${{ github.event.inputs.start_date || '2024-06-01' }}
          EXTRACT_END: ${{ github.event.inputs.end_date || '2024-06-30' }}
        run: python main.py --start "$EXTRACT_START" --end "$EXTRACT_END" --id-list "${{ matrix.chunk.ids }}"

      - name: Commit and Push DB
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --local core.quotepath false
          
          # 並列実行時の衝突回避リトライループ
          MAX_RETRIES=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            git pull --rebase origin main
            if [ "$(find ./data -name "*.db" | wc -l)" -gt 0 ]; then
              git add "./data/**/*.db"
              git commit -m "chore: Extract chunk ${{ matrix.chunk.idx }} (IDs: ${{ matrix.chunk.ids[:20] }}...)" || exit 0
              if git push origin main; then
                echo "Push successful"
                break
              fi
            else
              echo "No files to commit"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT+1))
            sleep $((RANDOM % 10 + 5))
          done
